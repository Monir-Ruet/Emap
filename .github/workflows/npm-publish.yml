name: Deploy Emap

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  Deploy-EMap:
    name: Build and Deploy Election Map
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24.x"

      - name: Create .env from GitHub secret
        run: |
          echo "${{ secrets.ENV }}" > .env

      - name: Install Dependencies
        run: npm ci

      - name: Build Next.js App
        run: npm run build

      - name: Sync Files to Remote Server
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          PORT: ${{ secrets.SSH_PORT }}
          PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y rsync sshpass
          echo "âš¡ Syncing Emap to /home/fahim/Emap"
          sshpass -p "$PASSWORD" rsync -avz --delete \
            --exclude ".git" \
            --exclude "node_modules" \
            --exclude ".github" \
            -e "ssh -p $PORT -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ./ $USER@$HOST:/home/fahim/Emap/

      - name: ğŸ” Install & Start Emap
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |

            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

            nvm use 24

            node -v
            pm2 -v

            cd /home/fahim/Emap

            echo "ğŸ“¦ Installing production dependencies"
            npm install
            npx prisma generate

            echo "ğŸ—ï¸ Building production bundle"
            npm run build

            if pm2 describe Emap > /dev/null; then
              echo "â™»ï¸ Restarting PM2 process: Emap"
              pm2 restart Emap
            else
              echo "ğŸ†• Starting PM2 process: Emap"
              pm2 start npm --name "Emap" -- run start
            fi
            pm2 save

      - name: âœ… Deployment Complete
        run: echo "ğŸš€ Emap deployed successfully!"
